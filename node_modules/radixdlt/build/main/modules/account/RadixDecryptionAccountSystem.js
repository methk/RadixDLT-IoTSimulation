"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var RadixECIES_1 = tslib_1.__importDefault(require("../crypto/RadixECIES"));
var RadixDecryptionAccountSystem = /** @class */ (function () {
    function RadixDecryptionAccountSystem(decryptionProvider) {
        this.name = 'DECRYPTION';
        if (decryptionProvider) {
            this.decryptionProvider = decryptionProvider;
        }
    }
    RadixDecryptionAccountSystem.prototype.processAtomUpdate = function (atomUpdate) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var e_1, _a, atom, privateKey, _b, _c, protector, error_1, e_1_1, rawPayload, error_2;
            return tslib_1.__generator(this, function (_d) {
                switch (_d.label) {
                    case 0:
                        atom = atomUpdate.atom;
                        if (!(this.decryptionProvider &&
                            atom.hasOwnProperty('encryptor') &&
                            atom.hasOwnProperty('encrypted'))) return [3 /*break*/, 17];
                        privateKey = null;
                        _d.label = 1;
                    case 1:
                        _d.trys.push([1, 8, 9, 10]);
                        _b = tslib_1.__values(atom.encryptor
                            .protectors), _c = _b.next();
                        _d.label = 2;
                    case 2:
                        if (!!_c.done) return [3 /*break*/, 7];
                        protector = _c.value;
                        _d.label = 3;
                    case 3:
                        _d.trys.push([3, 5, , 6]);
                        return [4 /*yield*/, this.decryptionProvider.decryptECIESPayload(protector.data)];
                    case 4:
                        privateKey = _d.sent();
                        return [3 /*break*/, 6];
                    case 5:
                        error_1 = _d.sent();
                        return [3 /*break*/, 6];
                    case 6:
                        _c = _b.next();
                        return [3 /*break*/, 2];
                    case 7: return [3 /*break*/, 10];
                    case 8:
                        e_1_1 = _d.sent();
                        e_1 = { error: e_1_1 };
                        return [3 /*break*/, 10];
                    case 9:
                        try {
                            if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
                        }
                        finally { if (e_1) throw e_1.error; }
                        return [7 /*endfinally*/];
                    case 10:
                        if (!privateKey) return [3 /*break*/, 15];
                        _d.label = 11;
                    case 11:
                        _d.trys.push([11, 13, , 14]);
                        return [4 /*yield*/, RadixECIES_1.default.decrypt(privateKey, atom.encrypted.data)];
                    case 12:
                        rawPayload = _d.sent();
                        atom.payload = rawPayload.toString();
                        return [3 /*break*/, 14];
                    case 13:
                        error_2 = _d.sent();
                        console.error('Decrypted a protector but unable to decrypt payload', atom);
                        return [3 /*break*/, 14];
                    case 14: return [3 /*break*/, 16];
                    case 15:
                        console.warn('Unable to decrypt any protectors', atom);
                        _d.label = 16;
                    case 16: return [3 /*break*/, 18];
                    case 17:
                        if (atom.hasOwnProperty('encrypted') &&
                            !atom.hasOwnProperty('encryptor')) {
                            atom.payload = atom.encrypted.data.toString();
                        }
                        _d.label = 18;
                    case 18: return [2 /*return*/];
                }
            });
        });
    };
    return RadixDecryptionAccountSystem;
}());
exports.default = RadixDecryptionAccountSystem;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmFkaXhEZWNyeXB0aW9uQWNjb3VudFN5c3RlbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tb2R1bGVzL2FjY291bnQvUmFkaXhEZWNyeXB0aW9uQWNjb3VudFN5c3RlbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSw0RUFBNkM7QUFJN0M7SUFJSSxzQ0FBWSxrQkFBNEM7UUFIakQsU0FBSSxHQUFHLFlBQVksQ0FBQTtRQUl0QixJQUFJLGtCQUFrQixFQUFFO1lBQ3BCLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxrQkFBa0IsQ0FBQTtTQUMvQztJQUNMLENBQUM7SUFFWSx3REFBaUIsR0FBOUIsVUFBK0IsVUFBMkI7Ozs7Ozt3QkFDaEQsSUFBSSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUE7NkJBR3hCLENBQUEsSUFBSSxDQUFDLGtCQUFrQjs0QkFDdkIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUM7NEJBQ2hDLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLENBQUEsRUFGaEMseUJBRWdDO3dCQUU1QixVQUFVLEdBQUcsSUFBSSxDQUFBOzs7O3dCQUVHLEtBQUEsaUJBQUMsSUFBeUIsQ0FBQyxTQUFTOzZCQUN2RCxVQUFVLENBQUE7Ozs7d0JBREosU0FBUzs7Ozt3QkFHQyxxQkFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsbUJBQW1CLENBQzFELFNBQVMsQ0FBQyxJQUFJLENBQ2pCLEVBQUE7O3dCQUZELFVBQVUsR0FBRyxTQUVaLENBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OzZCQU1MLFVBQVUsRUFBVix5QkFBVTs7Ozt3QkFFYSxxQkFBTSxvQkFBVSxDQUFDLE9BQU8sQ0FDdkMsVUFBVSxFQUNULElBQXlCLENBQUMsU0FBUyxDQUFDLElBQUksQ0FDNUMsRUFBQTs7d0JBSEssVUFBVSxHQUFHLFNBR2xCO3dCQUNELElBQUksQ0FBQyxPQUFPLEdBQUcsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFBOzs7O3dCQUVwQyxPQUFPLENBQUMsS0FBSyxDQUNULHFEQUFxRCxFQUNyRCxJQUFJLENBQ1AsQ0FBQTs7Ozt3QkFHTCxPQUFPLENBQUMsSUFBSSxDQUFDLGtDQUFrQyxFQUFFLElBQUksQ0FBQyxDQUFBOzs7O3dCQUV2RCxJQUNILElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDOzRCQUNoQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLEVBQ25DOzRCQUNFLElBQUksQ0FBQyxPQUFPLEdBQUksSUFBeUIsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFBO3lCQUN0RTs7Ozs7O0tBQ0o7SUFDTCxtQ0FBQztBQUFELENBQUMsQUF0REQsSUFzREMifQ==