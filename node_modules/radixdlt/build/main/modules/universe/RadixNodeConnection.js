"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var Rx_1 = require("rxjs/Rx");
var rpc_websockets_1 = require("rpc-websockets");
var RadixAtomModel_1 = require("../RadixAtomModel");
var events_1 = tslib_1.__importDefault(require("events"));
var RadixNodeConnection = /** @class */ (function (_super) {
    tslib_1.__extends(RadixNodeConnection, _super);
    function RadixNodeConnection(node, nodeRPCAddress) {
        var _this = _super.call(this) || this;
        _this.node = node;
        _this.nodeRPCAddress = nodeRPCAddress;
        _this._subscriptions = {};
        _this._atomUpdateSubjects = {};
        _this.lastSubscriberId = 1;
        _this.ping = function () {
            if (_this.isReady()) {
                _this._socket
                    .call('Network.getSelf', {
                    id: 0,
                }).then(function (response) {
                    // console.log('Ping', response)
                });
            }
        };
        _this.close = function () {
            _this._socket.close();
        };
        _this._onClosed = function () {
            console.log('Socket closed');
            clearInterval(_this.pingInterval);
            // Close subject
            for (var subscriberId in _this._subscriptions) {
                var subscription = _this._subscriptions[subscriberId];
                if (!subscription.closed) {
                    subscription.error('Socket closed');
                }
            }
            for (var subscriberId in _this._atomUpdateSubjects) {
                var subject = _this._atomUpdateSubjects[subscriberId];
                if (!subject.closed) {
                    subject.error('Socket closed');
                }
            }
            _this.emit('closed');
        };
        _this._onAtomSubmissionStateUpdate = function (notification) {
            console.log('Atom Submission state update', notification);
            // Handle atom state update
            var subscriberId = notification.subscriberId;
            var value = notification.value;
            var message = notification.message;
            var subject = _this._atomUpdateSubjects[subscriberId];
            switch (value) {
                case 'SUBMITTING':
                case 'SUBMITTED':
                    subject.next(value);
                    break;
                case 'STORED':
                    subject.next(value);
                    subject.complete();
                    break;
                case 'COLLISION':
                case 'ILLEGAL_STATE':
                case 'UNSUITABLE_PEER':
                case 'VALIDATION_ERROR':
                    subject.error(value + ': ' + message);
                    break;
            }
        };
        _this._onAtomReceivedNotification = function (notification) {
            var e_1, _a;
            console.log('Atom received', notification);
            // Store atom for testing
            // let jsonPath = './atomNotification.json'
            // // let jsonPath = path.join(__dirname, '..', '..', '..', '..', 'atomNotification.json')
            // console.log(jsonPath)
            // fs.writeFile(jsonPath, JSON.stringify(notification), (error) => {
            //    // Throws an error, you could also catch it here
            //    if (error) { throw error }
            //    // Success case, the file was saved
            //    console.log('Atom saved!')
            // })
            var deserializedAtoms = RadixAtomModel_1.RadixSerializer.fromJson(notification.atoms);
            console.log(deserializedAtoms);
            // Check HIDs for testing
            for (var i = 0; i < deserializedAtoms.length; i++) {
                var deserializedAtom = deserializedAtoms[i];
                var serializedAtom = notification.atoms[i];
                if (serializedAtom.hid &&
                    deserializedAtom.hid.equals(RadixAtomModel_1.RadixEUID.fromJson(serializedAtom.hid))) {
                    console.log('HID match');
                }
                else if (serializedAtom.hid) {
                    console.error('HID mismatch');
                }
            }
            // Forward atoms to correct wallets
            var subscription = _this._subscriptions[notification.subscriberId];
            try {
                for (var deserializedAtoms_1 = tslib_1.__values(deserializedAtoms), deserializedAtoms_1_1 = deserializedAtoms_1.next(); !deserializedAtoms_1_1.done; deserializedAtoms_1_1 = deserializedAtoms_1.next()) {
                    var atom = deserializedAtoms_1_1.value;
                    subscription.next({
                        action: 'STORE',
                        atom: atom,
                    });
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (deserializedAtoms_1_1 && !deserializedAtoms_1_1.done && (_a = deserializedAtoms_1.return)) _a.call(deserializedAtoms_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
        };
        _this.node = node;
        return _this;
    }
    RadixNodeConnection.prototype.getSubscriberId = function () {
        this.lastSubscriberId++;
        return this.lastSubscriberId;
    };
    /**
     * Check whether the node connection is ready for requests
     * @returns true if ready
     */
    RadixNodeConnection.prototype.isReady = function () {
        return this._socket && this._socket.ready;
    };
    /**
     * Opens connection
     * @returns a promise that resolves once the connection is ready, or rejects on error or timeout
     */
    RadixNodeConnection.prototype.openConnection = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, new Promise(function (resolve, reject) {
                        _this.address = _this.nodeRPCAddress(_this.node.host.ip);
                        // For testing atom queueing during connection issues
                        // if (Math.random() > 0.1) {
                        //    this.address += 'garbage'
                        // }
                        console.log('connecting to ' + _this.address);
                        _this._socket = new rpc_websockets_1.Client(_this.address, {
                            reconnect: false
                        });
                        _this._socket.on('close', _this._onClosed);
                        _this._socket.on('error', function (error) {
                            console.error(error);
                            reject(error);
                        });
                        setTimeout(function () {
                            if (!_this._socket.ready) {
                                console.warn('Socket timeout');
                                _this._socket.close();
                                _this.emit('closed');
                                reject('Timeout');
                            }
                        }, 5000);
                        _this._socket.on('open', function () {
                            _this.pingInterval = setInterval(_this.ping, 10000);
                            _this.emit('open');
                            _this._socket.on('Atoms.subscribeUpdate', _this._onAtomReceivedNotification);
                            _this._socket.on('AtomSubmissionState.onNext', _this._onAtomSubmissionStateUpdate);
                            resolve();
                        });
                    })];
            });
        });
    };
    /**
     * Subscribe for all existing and future atoms for a given address
     * @param address base58 formatted address
     * @returns a stream of atoms
     */
    RadixNodeConnection.prototype.subscribe = function (address) {
        var subscriberId = this.getSubscriberId();
        var subscription = new Rx_1.Subject();
        this._subscriptions[subscriberId] = subscription;
        this._socket
            .call('Atoms.subscribe', {
            subscriberId: subscriberId,
            query: {
                destinationAddress: address,
            },
        })
            .then(function (response) {
            console.log('Subscribed for address ' + address, response);
        })
            .catch(function (error) {
            console.error(error);
            subscription.error(error);
        });
        return subscription;
    };
    /**
     * Submit an atom to the ledger
     * @param atom
     * @returns A stream of the status of the atom submission
     */
    RadixNodeConnection.prototype.submitAtom = function (atom) {
        // Store atom for testing
        // let jsonPath = path.join('./submitAtom.json')
        // console.log(jsonPath)
        // fs.writeFile(jsonPath, JSON.stringify(atom.toJson()), (error) => {
        //    // Throws an error, you could also catch it here
        //    if (error) { throw error }
        var _this = this;
        //    // Success case, the file was saved
        //    console.log('Atom saved!')
        // })
        var subscriberId = this.getSubscriberId();
        var atomStateSubject = new Rx_1.BehaviorSubject('CREATED');
        this._atomUpdateSubjects[subscriberId] = atomStateSubject;
        var timeout = setTimeout(function () {
            _this._socket.close();
            atomStateSubject.error('Socket timeout');
        }, 5000);
        this._socket
            .call('Universe.submitAtomAndSubscribe', {
            subscriberId: subscriberId,
            atom: atom.toJson()
        })
            .then(function () {
            clearTimeout(timeout);
            atomStateSubject.next('SUBMITTED');
        })
            .catch(function (error) {
            clearTimeout(timeout);
            atomStateSubject.error(error);
        });
        return atomStateSubject;
    };
    /**
     * NOT IMPLEMENTED
     * Query the ledger for an atom by its id
     * @param id
     * @returns The atom
     */
    RadixNodeConnection.prototype.getAtomById = function (id) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                // TODO: everything
                return [2 /*return*/, this._socket
                        .call('Atoms.getAtomInfo', { id: id.toJson() })
                        .then(function (response) {
                        return RadixAtomModel_1.RadixSerializer.fromJson(response.result);
                    })];
            });
        });
    };
    return RadixNodeConnection;
}(events_1.default.EventEmitter));
exports.RadixNodeConnection = RadixNodeConnection;
exports.default = RadixNodeConnection;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmFkaXhOb2RlQ29ubmVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tb2R1bGVzL3VuaXZlcnNlL1JhZGl4Tm9kZUNvbm5lY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsOEJBQWtEO0FBQ2xELGlEQUF1QztBQUl2QyxvREFBMEY7QUFFMUYsMERBQTJCO0FBbUIzQjtJQUF5QywrQ0FBbUI7SUFleEQsNkJBQXFCLElBQWUsRUFBVyxjQUEwQztRQUF6RixZQUNJLGlCQUFPLFNBRVY7UUFIb0IsVUFBSSxHQUFKLElBQUksQ0FBVztRQUFXLG9CQUFjLEdBQWQsY0FBYyxDQUE0QjtRQVpqRixvQkFBYyxHQUVsQixFQUFFLENBQUE7UUFFRSx5QkFBbUIsR0FFdkIsRUFBRSxDQUFBO1FBRUUsc0JBQWdCLEdBQUcsQ0FBQyxDQUFBO1FBc0JwQixVQUFJLEdBQUc7WUFDWCxJQUFJLEtBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDaEIsS0FBSSxDQUFDLE9BQU87cUJBQ1gsSUFBSSxDQUFDLGlCQUFpQixFQUFFO29CQUNyQixFQUFFLEVBQUUsQ0FBQztpQkFDUixDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsUUFBYTtvQkFDbEIsZ0NBQWdDO2dCQUNwQyxDQUFDLENBQUMsQ0FBQTthQUNMO1FBQ0wsQ0FBQyxDQUFBO1FBZ0pNLFdBQUssR0FBRztZQUNYLEtBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUE7UUFDeEIsQ0FBQyxDQUFBO1FBRU8sZUFBUyxHQUFHO1lBQ2hCLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUE7WUFFNUIsYUFBYSxDQUFDLEtBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQTtZQUVoQyxnQkFBZ0I7WUFDaEIsS0FBSyxJQUFNLFlBQVksSUFBSSxLQUFJLENBQUMsY0FBYyxFQUFFO2dCQUM1QyxJQUFNLFlBQVksR0FBRyxLQUFJLENBQUMsY0FBYyxDQUFD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